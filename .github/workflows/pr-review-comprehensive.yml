name: PR Review with Progress Tracking

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  review-with-tracking:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: PR Review with Progress Tracking
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          track_progress: true

          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Perform a comprehensive code review with the following focus areas:

            ## 1. Release Workflow Compliance (CRITICAL)

            This project uses Release Please with Conventional Commits. Check:

            **Commit Message Format:**
            - All commits MUST follow conventional commit format: `type(scope): description`
            - Valid types: `feat`, `fix`, `perf`, `refactor`, `docs`, `test`, `ci`, `build`, `chore`, `style`
            - Type must be lowercase
            - Description must be lowercase and not end with a period
            - Breaking changes must include `BREAKING CHANGE:` in the commit footer

            **Version Bump Rules (explain to contributor):**
            - `feat:` → Minor version bump (0.4.0 → 0.5.0)
            - `fix:`, `perf:`, `refactor:` → Patch version bump (0.4.0 → 0.4.1)
            - `docs:`, `test:`, `ci:`, `build:`, `chore:`, `style:` → No version bump
            - `BREAKING CHANGE:` footer → Major version bump

            **If commits don't follow the format:**
            - List each non-compliant commit
            - Show the correct format it should use
            - Suggest squashing/rewording before merge

            Run this command to check commits:
            ```
            git log --oneline origin/main..HEAD
            ```

            ## 2. Code Quality
            - Clean code principles and best practices
            - Proper error handling and edge cases
            - Code readability and maintainability

            ## 3. Security
            - Check for potential security vulnerabilities
            - Validate input sanitization
            - Review authentication/authorization logic
            - Check for secrets or credentials in code

            ## 4. Performance
            - Identify potential performance bottlenecks
            - Check for memory leaks or resource issues

            ## 5. Testing
            - Verify adequate test coverage for new features
            - Review test quality and edge cases

            ## 6. Documentation
            - New features should update README.md if user-facing
            - Breaking changes should be clearly documented

            ## Review Output Format

            Start your review with a **Release Compliance Summary**:

            ```
            ## Release Compliance Check

            | Commit | Format | Type | Valid |
            |--------|--------|------|-------|
            | abc123 | feat: add feature | feat | ✅ |
            | def456 | Update readme | INVALID | ❌ |

            **Action Required:** [Yes/No]
            ```

            If any commits are invalid, provide clear instructions on how to fix them
            (e.g., interactive rebase commands).

            Then proceed with the rest of the code review using inline comments
            for specific issues and top-level comments for general observations.

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(git log:*),Bash(git show:*)"
